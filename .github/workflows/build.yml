name: Build Flutter Apps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: Verify Keystore
        run: |
          echo "Using committed luxor-debug.keystore"
          keytool -list -v -keystore android/app/luxor-debug.keystore -alias luxor -storepass luxor123 2>/dev/null | grep SHA1 || true

      - name: Generate Platform Files
        run: |
          # Backup our custom build.gradle and keystore before flutter create
          cp android/app/build.gradle /tmp/build.gradle.backup
          cp android/app/luxor-debug.keystore /tmp/luxor-debug.keystore.backup
          cp android/app/google-services.json /tmp/google-services.json.backup

          flutter create . --platforms android --project-name ai_browser_agent

          # Restore our custom build.gradle with signing config
          cp /tmp/build.gradle.backup android/app/build.gradle
          cp /tmp/luxor-debug.keystore.backup android/app/luxor-debug.keystore
          cp /tmp/google-services.json.backup android/app/google-services.json

          # Fix Gradle version - AGP 8.1.0 requires Gradle 8.0+
          sed -i 's/gradle-7.6.3-all.zip/gradle-8.3-all.zip/' android/gradle/wrapper/gradle-wrapper.properties
          sed -i 's/gradle-7.5-all.zip/gradle-8.3-all.zip/' android/gradle/wrapper/gradle-wrapper.properties

          # Remove generated styles.xml to avoid duplicate resources with themes.xml
          rm -f android/app/src/main/res/values/styles.xml
          rm -f android/app/src/main/res/values-night/styles.xml

          # Add permissions to AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.RECORD_AUDIO" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.BLUETOOTH" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.USE_BIOMETRIC" />' android/app/src/main/AndroidManifest.xml

          # Add Queries for url_launcher
          sed -i '/<application/i \    <queries><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="https" /></intent><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="http" /></intent></queries>' android/app/src/main/AndroidManifest.xml

          # Update minSdkVersion to 23 for modern plugins
          sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 23/' android/app/build.gradle

          # Fix Biometric: Change FlutterActivity to FlutterFragmentActivity
          sed -i 's/import io.flutter.embedding.android.FlutterActivity/import io.flutter.embedding.android.FlutterFragmentActivity/' android/app/src/main/kotlin/com/example/ai_browser_agent/MainActivity.kt
          sed -i 's/class MainActivity: FlutterActivity()/class MainActivity: FlutterFragmentActivity()/' android/app/src/main/kotlin/com/example/ai_browser_agent/MainActivity.kt

      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: luxor-browser-android
          path: build/app/outputs/flutter-apk/app-release.apk

  build-linux:
    name: Build Linux Desktop
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev libappindicator3-dev \
            libnotify-dev clang cmake pkg-config liblzma-dev
          # Install webkit2gtk (try 4.1 first for Ubuntu 22.04+, then 4.0)
          sudo apt-get install -y libwebkit2gtk-4.1-dev 2>/dev/null || sudo apt-get install -y libwebkit2gtk-4.0-dev

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Generate Platform Files
        run: |
          # Generate Linux platform files
          flutter create . --platforms linux --project-name luxor_browser

          # Update application name and ID in CMakeLists.txt
          sed -i 's/set(BINARY_NAME "luxor_browser")/set(BINARY_NAME "luxor-browser")/' linux/CMakeLists.txt || true
          sed -i 's/set(APPLICATION_ID "com.example.luxor_browser")/set(APPLICATION_ID "com.luxor.browser")/' linux/CMakeLists.txt || true

          # Update window title
          sed -i 's/gtk_header_bar_set_title(header_bar, "luxor_browser")/gtk_header_bar_set_title(header_bar, "Luxor Browser")/' linux/my_application.cc || true
          sed -i 's/gtk_window_set_title(window, "luxor_browser")/gtk_window_set_title(window, "Luxor Browser")/' linux/my_application.cc || true

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Package Linux App
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ../../../../../luxor-browser-linux-x64.tar.gz *

      - name: Upload Linux Build
        uses: actions/upload-artifact@v4
        with:
          name: luxor-browser-linux
          path: luxor-browser-linux-x64.tar.gz

  release:
    name: Create Release
    needs: [build-android, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: luxor-browser-android
          path: ./artifacts

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: luxor-browser-linux
          path: ./artifacts

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ steps.date.outputs.date }}
          name: Luxor Browser Build ${{ steps.date.outputs.date }}
          body: |
            Automated build from main branch.

            ## Downloads
            - **Android**: luxor-browser-android.apk
            - **Linux**: luxor-browser-linux-x64.tar.gz (Extract and run `luxor_browser`)

            ## Installation

            ### Android
            1. Download the APK
            2. Enable "Install from unknown sources" in settings
            3. Install the APK

            ### Linux (Mint/Ubuntu/Debian)
            1. Download and extract the tar.gz file
            2. Install dependencies: `sudo apt install libgtk-3-0 libwebkit2gtk-4.1-0`
            3. Run: `./luxor_browser`
          files: |
            ./artifacts/app-release.apk
            ./artifacts/luxor-browser-linux-x64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
